name: Build, Sign & Release EXE

on:
  push:
    tags:
      - "v*"

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }
          pip install pyinstaller

      - name: Build EXE (PyInstaller)
        shell: pwsh
        run: |
          pyinstaller `
            --onefile `
            --noconsole `
            --name "timetrac" `
            --icon ".\timetable_icon.ico" `
            --version-file ".\version_info.txt" `
            ".\main.py"

      - name: Decode PFX
        shell: pwsh
        run: |
          $pfxPath = "$env:RUNNER_TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}"))
          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Find signtool.exe
        shell: pwsh
        run: |
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool\.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName
          if (-not $signtool) { throw "signtool.exe nicht gefunden" }
          "SIGNTOOL=$signtool" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Sign EXE
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          & "$env:SIGNTOOL" sign /v `
            /f "$env:PFX_PATH" /p "$env:PFX_PASSWORD" `
            /fd SHA256 /tr "http://timestamp.sectigo.com" /td SHA256 `
            ".\dist\timetrac.exe"

      - name: Package ZIP
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ".\release" | Out-Null
          Copy-Item ".\dist\timetrac.exe" ".\release\timetrac.exe" -Force
          Copy-Item ".\LICENSE" ".\release\LICENSE" -Force
          Compress-Archive `
            -Path ".\release\timetrac.exe", ".\release\LICENSE" `
            -DestinationPath ".\timetrac.zip" `
            -Force

      - name: Create checksum
        shell: pwsh
        run: |
          Get-FileHash ".\timetrac.zip" -Algorithm SHA256 |
            ForEach-Object { "$($_.Hash)  timetrac.zip" } |
            Out-File "timetrac.zip.sha256" -Encoding ASCII

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            timetrac.zip
            timetrac.zip.sha256
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ github.token }}
