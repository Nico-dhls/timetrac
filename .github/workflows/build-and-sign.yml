name: Build & Sign MSI (cx_Freeze)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      debug_version:
        description: 'Version für Debugging (z.B. 1.0.0)'
        required: true
        default: '0.0.0'

permissions:
  contents: write

jobs:
  build-sign-msi:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }
          pip install cx_Freeze

      # SCHRITT A: Version in setup.py schreiben
      # Wir suchen nach "VERSION_PLACEHOLDER" und ersetzen es durch den echten Tag (z.B. "1.0.2")
      - name: Inject Version into setup.py
        shell: pwsh
        run: |
          $tag = $env:GITHUB_REF_NAME.TrimStart("v")
          Write-Host "Setze Version auf: $tag"
          (Get-Content setup.py) -replace 'VERSION_PLACEHOLDER', $tag | Set-Content setup.py

      # SCHRITT B: MSI bauen
      # cx_Freeze erstellt nun die MSI mit der korrekten Version in den Metadaten
      - name: Build MSI
        shell: pwsh
        run: |
          python setup.py bdist_msi

      # SCHRITT C: Zertifikat vorbereiten
      - name: Decode PFX Certificate
        shell: pwsh
        run: |
          $pfxPath = Join-Path -Path $env:RUNNER_TEMP -ChildPath "codesign.pfx"
          $encodedBytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}")
          [IO.File]::WriteAllBytes($pfxPath, $encodedBytes)
          "PFX_PATH=$pfxPath" >> $env:GITHUB_ENV

      # SCHRITT D: Signtool finden
      - name: Find signtool.exe
        shell: pwsh
        run: |
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool\.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName
          "SIGNTOOL=$signtool" >> $env:GITHUB_ENV

      # SCHRITT E: Das MSI signieren
      # Wir suchen die MSI im dist-Ordner (Name ändert sich je nach Version) und signieren sie.
      - name: Sign MSI
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          $msiFile = Get-ChildItem ".\dist\*.msi" | Select-Object -First 1
          Write-Host "Signiere Datei: $($msiFile.FullName)"
          
          & "$env:SIGNTOOL" sign /v `
            /f "$env:PFX_PATH" /p "$env:PFX_PASSWORD" `
            /fd SHA256 /tr "http://timestamp.sectigo.com" /td SHA256 `
            $msiFile.FullName

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            dist/*.msi
          generate_release_notes: true
