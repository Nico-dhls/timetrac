name: Build, Sign & Release EXE

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }
          pip install pyinstaller

      # NEU: Erstellt die version_info.txt dynamisch aus dem Git-Tag
      - name: Generate Version Info
        shell: python
        run: |
          import os
          
          # Tag holen (z.B. "v1.5.0") und "v" entfernen -> "1.5.0"
          tag = os.environ.get("GITHUB_REF_NAME", "0.0.0").lstrip("v")
          
          # Version für Windows-Tuple splitten (1, 5, 0, 0)
          parts = [p for p in tag.split(".") if p.isdigit()]
          # Mit Nullen auffüllen bis 4 Stellen (Windows Standard)
          while len(parts) < 4:
              parts.append("0")
          
          version_tuple = f"({', '.join(parts)})"
          version_str = tag
          
          file_content = f"""
          # UTF-8
          VSVersionInfo(
            ffi=FixedFileInfo(
              filevers={version_tuple},
              prodvers={version_tuple},
              mask=0x3f,
              flags=0x0,
              OS=0x40004,
              fileType=0x1,
              subtype=0x0,
              date=(0,0)
            ),
            kids=[
              StringFileInfo([
                StringTable(
                  "040904B0",
                  [
                    StringStruct("CompanyName", "Nico Dahlhaus"),
                    StringStruct("ProductName", "TimeTrac"),
                    StringStruct("FileDescription", "TimeTrac – Zeiterfassung"),
                    StringStruct("ProductVersion", "{version_str}"),
                    StringStruct("FileVersion", "{version_str}"),
                    StringStruct("OriginalFilename", "timetrac.exe"),
                    StringStruct("LegalCopyright", "© 2025 – Developed by Nico Dahlhaus")
                  ]
                )
              ]),
              VarFileInfo([VarStruct("Translation", [1033, 1200])])
            ]
          )
          """
          
          with open("version_info.txt", "w", encoding="utf-8") as f:
              f.write(file_content)
          
          print(f"version_info.txt created for version {version_str}")

      - name: Build EXE (PyInstaller)
        shell: pwsh
        run: |
          # Hinweis: version_info.txt wurde im vorherigen Schritt erstellt
          pyinstaller `
            --onefile `
            --noconsole `
            --name "timetrac" `
            --icon ".\timetable_icon.ico" `
            --version-file ".\version_info.txt" `
            ".\main.py"

      - name: Decode PFX Certificate
        shell: pwsh
        run: |
          $pfxPath = Join-Path -Path $env:RUNNER_TEMP -ChildPath "codesign.pfx"
          $encodedBytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}")
          [IO.File]::WriteAllBytes($pfxPath, $encodedBytes)
          "PFX_PATH=$pfxPath" >> $env:GITHUB_ENV

      - name: Find signtool.exe
        shell: pwsh
        run: |
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool\.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName
          if (-not $signtool) { throw "signtool.exe nicht gefunden" }
          "SIGNTOOL=$signtool" >> $env:GITHUB_ENV

      - name: Sign EXE
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          & "$env:SIGNTOOL" sign /v `
            /f "$env:PFX_PATH" /p "$env:PFX_PASSWORD" `
            /fd SHA256 /tr "http://timestamp.sectigo.com" /td SHA256 `
            ".\dist\timetrac.exe"

      - name: Package ZIP
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ".\release" | Out-Null
          if (Test-Path ".\dist\timetrac.exe") { Copy-Item ".\dist\timetrac.exe" ".\release\timetrac.exe" -Force }
          if (Test-Path ".\LICENSE") { Copy-Item ".\LICENSE" ".\release\LICENSE" -Force }
          
          $compressFiles = @(".\release\timetrac.exe")
          if (Test-Path ".\release\LICENSE") { $compressFiles += ".\release\LICENSE" }
          
          Compress-Archive -Path $compressFiles -DestinationPath ".\timetrac.zip" -Force

      - name: Create checksum
        shell: pwsh
        run: |
          Get-FileHash ".\timetrac.zip" -Algorithm SHA256 |
            ForEach-Object { "$($_.Hash)  timetrac.zip" } |
            Out-File "timetrac.zip.sha256" -Encoding ASCII

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            timetrac.zip
            timetrac.zip.sha256
          generate_release_notes: true
