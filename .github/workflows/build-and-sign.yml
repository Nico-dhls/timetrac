name: Build and Sign EXE

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-sign:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }
          pip install pyinstaller

      - name: Build EXE (PyInstaller)
        shell: pwsh
        run: |
          pyinstaller `
            --onefile `
            --noconsole `
            --name "timetrac" `
            --icon ".\timetable_icon.ico" `
            --version-file ".\version_info.txt" `
            --add-data ".\timetable_icon.ico;." `
            ".\main.py"

      - name: Decode PFX
        shell: pwsh
        run: |
          $pfxPath = "$env:RUNNER_TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}"))
          "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Find signtool.exe
        shell: pwsh
        run: |
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool\.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName
          if (-not $signtool) { throw "signtool.exe nicht gefunden" }
          "SIGNTOOL=$signtool" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Sign EXE
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          $exe = ".\dist\timetrac.exe"
          & "$env:SIGNTOOL" sign /v `
            /f "$env:PFX_PATH" /p "$env:PFX_PASSWORD" `
            /fd SHA256 /tr "http://timestamp.sectigo.com" /td SHA256 `
            $exe

      - name: Verify signature (non-fatal)
        shell: pwsh
        run: |
          & "$env:SIGNTOOL" verify /pa ".\dist\timetrac.exe" ; $code=$LASTEXITCODE
          Get-AuthenticodeSignature ".\dist\timetrac.exe" | Format-List Status,StatusMessage
          if ($code -ne 0) { Write-Host "Verify failed on runner (trust store). Continuing."; exit 0 }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: signed-exe
          path: dist/timetrac.exe
