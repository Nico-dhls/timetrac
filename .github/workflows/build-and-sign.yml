name: Build, Sign & Release EXE

on:
  push:
    tags:
      - "v*"

# WICHTIG: Setzt die Berechtigungen für den GITHUB_TOKEN
permissions:
  contents: write

jobs:
  build-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }
          pip install pyinstaller

      - name: Build EXE (PyInstaller)
        shell: pwsh
        run: |
          # Stellen Sie sicher, dass Icon und Version-File existieren, sonst entfernen Sie die Zeilen
          pyinstaller `
            --onefile `
            --noconsole `
            --name "timetrac" `
            --icon ".\timetable_icon.ico" `
            --version-file ".\version_info.txt" `
            ".\main.py"

      - name: Decode PFX Certificate
        id: write_file
        shell: pwsh
        run: |
          $pfxPath = Join-Path -Path $env:RUNNER_TEMP -ChildPath "codesign.pfx"
          $encodedBytes = [Convert]::FromBase64String("${{ secrets.CODESIGN_PFX_BASE64 }}")
          [IO.File]::WriteAllBytes($pfxPath, $encodedBytes)
          
          # Sicherer Weg, ENV Var zu setzen
          "PFX_PATH=$pfxPath" >> $env:GITHUB_ENV

      - name: Find signtool.exe
        shell: pwsh
        run: |
          # Sucht dynamisch nach dem neuesten Signtool im Windows SDK
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe |
            Where-Object { $_.FullName -match "\\x64\\signtool\.exe$" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName
          
          if (-not $signtool) { throw "signtool.exe nicht gefunden" }
          
          Write-Host "Signtool gefunden: $signtool"
          "SIGNTOOL=$signtool" >> $env:GITHUB_ENV

      - name: Sign EXE
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.CODESIGN_PFX_PASSWORD }}
        run: |
          & "$env:SIGNTOOL" sign /v `
            /f "$env:PFX_PATH" /p "$env:PFX_PASSWORD" `
            /fd SHA256 /tr "http://timestamp.sectigo.com" /td SHA256 `
            ".\dist\timetrac.exe"

      - name: Package ZIP
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ".\release" | Out-Null
          
          # Prüfen ob Dateien existieren, um Fehler zu vermeiden
          if (Test-Path ".\dist\timetrac.exe") { Copy-Item ".\dist\timetrac.exe" ".\release\timetrac.exe" -Force }
          if (Test-Path ".\LICENSE") { Copy-Item ".\LICENSE" ".\release\LICENSE" -Force }
          
          # Zip erstellen
          $compressFiles = @(".\release\timetrac.exe")
          if (Test-Path ".\release\LICENSE") { $compressFiles += ".\release\LICENSE" }
          
          Compress-Archive -Path $compressFiles -DestinationPath ".\timetrac.zip" -Force

      - name: Create checksum
        shell: pwsh
        run: |
          Get-FileHash ".\timetrac.zip" -Algorithm SHA256 |
            ForEach-Object { "$($_.Hash)  timetrac.zip" } |
            Out-File "timetrac.zip.sha256" -Encoding ASCII

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
            timetrac.zip
            timetrac.zip.sha256
          generate_release_notes: true
          draft: false
          prerelease: false
